---
header-includes:
   - \usepackage{bbm}
   - \usepackage{graphicx}
   - \usepackage{booktabs}
   - \usepackage{fancyhdr}
   - \usepackage{caption}
   - \usepackage{geometry}
   - \usepackage{float}
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
fontsize: 12pt
numbersections: true
fig_caption: yes
geometry: margin=2.5cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rmarkdown)
library(knitr)
library(xtable)
library(car)
library(carData)
```

\setlength{\parskip}{0em}
\pagenumbering{arabic}
\pagestyle{fancy}
\fancyhf{}
\rhead{Émile \textsc{Bourban}, Guillaume \textsc{Pillet}}
\lhead{Florent \textsc{Sierro}, Hugo \textsc{Michel}}
\rfoot{Page \thepage}

\begin{center}
\LARGE{\bfseries{Finding the best parametrization for ice cream batter}}
\end{center}

```{r LoadData, echo=FALSE}
# Set the working directory :

 setwd("C:\\Users\\Florent\\Documents\\\\GitHub\\Biostats")
# setwd("C:\\Users\\Emile....")
# setwd("C:\\Users\\Georges\\Documents\\GitHub\\Biostats")
# setwd("C:\\Users\\gpill\\Documents\\GitHub\\Biostats")

# Clear variables
rm(list=ls(all=TRUE))
# Load Data
icecream <- read.csv("icecream.csv")
# str(icecream)
```

<!-- L'assistant a dit : Explorer le model, en essayé plrs puis choisr celui qu'on pense le meilleur, puis après afficher les résultats du modèle chosit et voir par exemple les valeur extremes ! -->

\section{Introduction}
Manufacturing ice cream cones requies baking of a blatter before rolling it into specifical conic shapes. This batter is compoosed of many ingredients (flour, sugar, water ..) and its quality is a crucial point that was studied by three scientists in a paper [1] they published in 1988. The stake of this study was to optimize the automatization of the manufacturing. Indeed, different problems may emerge from too thin (sticking problem) or too thick (uniformity problem) batter.  
To prevent this situation, they evaluated the quality of the batter used to prepare the cones depending on several factors. The factor we studied is the viscosity of the flour, influenced by its content in moisture, protein and ash. We explored the data and developed a model to clarify the relationship between these elements  .

\section{Multiple regression analysis}
\subsection{Pairwise simple correlations}
As a dataset is the measure of several variables, the first thing to do is to explore it. Indeed, we first determine the inter-relation between the different predicitive factors and look at their correlation. In order to do so, we look at scatter plots, that display all the bivariate relations between the three parameters. This pairwise correlation of all predictive variables allows to better see the relationships between pairs of variable. Moreover, we compute the correlation coefficent, which is the strength of the association between two variables.

```{r covariances and correlations, echo=FALSE, results="hide"}
covariances <- round(cov(icecream[c(2,3,4)]),2)
correlations <- round(cor(icecream[c(2,3,4)]),2)

covtable <- kable(xtable(covariances), format = "latex", booktabs = TRUE)
cortable <- kable(xtable(correlations),format = "latex", booktabs = TRUE)
```

According to Figure 1 and Table 1, we can observe that the strongest relation is between the protein and ash contents. Indeed, their correlation coeffcient r=`r correlations["ash","protein"]`, which is the closest to |r|=1. This is likely due to the fact that proteins can capture inorganic materials (i.e. the ashes) easier than the moisture does. Indeed, the moisture is made of molecules of water and have no charges to interact with ashes which are most of the time charged as the proteins. Looking at the correlation coefficients of moisture with protein and ash (r=`r correlations["moisture","protein"]` and r=`r correlations["moisture","ash"]` respectively), we see that they are both negative, close to each other and not so strong. 

\begin{table}[H]
\footnotesize
\center
\parbox{.45\textwidth}{
      \vspace{0.3cm}
      `r cortable`
      \caption{\label{table:correlations}Correlation values}
      }
\parbox{.45\textwidth}{
      \vspace{0.3cm}
      `r covtable`
      \caption{\label{table:covariances}Covariances values}
      }
\end{table}

```{r pairwise regression, echo=FALSE, results="hide", fig.cap="\\label{fig:correlations} Pairwise scatter plot for all predictive variables", out.extra='trim={0 0.7cm 0 0.7cm},clip', out.width="100%", fig.align="center"}
pairs( ~ moisture + protein + ash, data=icecream)
```

\subsection{Model selection}
Emile
\subsubsection{Forward selection} 
Emile
\subsubsection{Backward selection} 
Emile

\section{Regression diagnostics}
We have now selected a plausible best model for blatter bakery. However, we have to ensure this model is robust and well suited. We will compare the predicted value of the model with the real obtained values, as well as comparing some data with other possible models.

\subsection{Q-Q plot}
```{r , echo=FALSE, results="hide", fig.cap="\\label{fig::QQ}Normal Q-Q plot for the residuals from the lmbest", out.extra='trim={0 0.5cm 0 2cm},clip', out.width="100%", fig.align="center", fig.pos="H"}

lm.best <- lm(viscosity ~ protein + ash, data=icecream)
tmp <- qqnorm(residuals(lm.best), pch=20)
qqline(residuals(lm.best))
diff <- (tmp$x - tmp$y)
###display value too far from line
text(tmp$x,tmp$y,ifelse((abs(diff)>20), names(diff),""), pos=3)
rm(tmp,diff)
```

We display the Q-Q plot to see if our data are normally distributed. Indeed, they should be close to the line y=x to infer a normal distribution. Unfortunately, this is not the case here, as one tail is far away from the line.
The labeled points are those that deviate the most from the line and represent the extreme cases. (Si on a pas d'explication d'ici la) --> Note that we work here with a small amount of data (*n=39*) and QQ-plots tend to stabilize with larger number of values. We shouldn't try to "over-interpret" anormal phenomenon as they may occur frequently with such a small data set.

\subsection{Observed vs Fitted}
```{r, echo=FALSE, results="hide", fig.cap="\\label{fig::fitted}Fitted vs observed ratio", out.extra='trim={0 0.5cm 0 2cm},clip', out.width="100%", fig.align="center", fig.pos="H"}
###observed vs fitted
plot(icecream$viscosity ~ fitted(lm.best), pch=20, xlab="Fitted", ylab="Observed")
abline(0,1); grid(col="black")
par(mfrow=c(1,1))
```

We need to compare the actual outputs of our chosen model with the observed values. This comparison is represented in Figure 3.
The ideal data would follow the line y = x, meaning the modeled values are exactly equaled to the observed ones. This is not the case with our model, as a lot of points are quite far from this ideal line. Our model is therefore not optimal, as either we miss some parameters or some of them give wrong information. The next step to determine if our model could be improved is to look at the variance inflation factor (VIF).

\subsection{Variance inflation factor}
Variance Inflation factor, or simply put VIF, will allow us to check for depedancies among our factors (multicolinearity). If this is the case, we will remove certain factors that would add redundancies in our model. A VIF above 5 is to be considered a caution and above 10 as a clear sign of multicolinearity.
Let's use VIF on our best model:

```{r, message=FALSE, echo=FALSE, warning=FALSE, results="hidden"}
require(car)
viftable <- kable(vif(lm.best), col.names = c("VIF"), format = "latex", booktabs = TRUE)
```

\begin{table}[H]
\footnotesize
\center
\parbox{\textwidth}{
      \begin{center}
      \vspace{0.3cm}
      `r viftable`
      \caption{\label{table:viftable}VIF values}
      \end{center}
      }
\end{table}

We can see that the values are even below 5, indicating no colinearity amoung these two factors. Hence, our model does not contain too much parameter, or at least dependant factors. Therefore, VIF cannot really explain the difference between our model outputs and the observed data from figure 3. The obvious answer (to be explored!) could be our model lacks some relevant data brough by another/other parameter(s).

\section{Conclusion}
GUILLAUME ON COMPTE SUR TOI !!!!

\section{}
[1] V.T.Huanga, J.B.Lindamood1 & P.M.T.Hansen - Ice-cream cone baking: dependence of baking performance on flour and batter viscosity, 1988